version: '3.8'

services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: event-service-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: crm
    ports:
      - "13306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 5s
      retries: 10

  # Redis Cluster
  redis-node-1:
    image: redis:7-alpine
    container_name: redis-node-1
    command: redis-server --port 7001 --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes
    ports:
      - "7001:7001"
    volumes:
      - redis_1_data:/data

  redis-node-2:
    image: redis:7-alpine
    container_name: redis-node-2
    command: redis-server --port 7002 --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes
    ports:
      - "7002:7002"
    volumes:
      - redis_2_data:/data

  redis-node-3:
    image: redis:7-alpine
    container_name: redis-node-3
    command: redis-server --port 7003 --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes
    ports:
      - "7003:7003"
    volumes:
      - redis_3_data:/data

  redis-node-4:
    image: redis:7-alpine
    container_name: redis-node-4
    command: redis-server --port 7004 --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes
    ports:
      - "7004:7004"
    volumes:
      - redis_4_data:/data

  redis-node-5:
    image: redis:7-alpine
    container_name: redis-node-5
    command: redis-server --port 7005 --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes
    ports:
      - "7005:7005"
    volumes:
      - redis_5_data:/data

  redis-node-6:
    image: redis:7-alpine
    container_name: redis-node-6
    command: redis-server --port 7006 --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes
    ports:
      - "7006:7006"
    volumes:
      - redis_6_data:/data

  # Redis Cluster Creator (runs once to set up cluster)
  redis-cluster-creator:
    image: redis:7-alpine
    container_name: redis-cluster-creator
    command: redis-cli --cluster create redis-node-1:7001 redis-node-2:7002 redis-node-3:7003 redis-node-4:7004 redis-node-5:7005 redis-node-6:7006 --cluster-replicas 1 --cluster-yes
    depends_on:
      - redis-node-1
      - redis-node-2
      - redis-node-3
      - redis-node-4
      - redis-node-5
      - redis-node-6

  # Event Service
  event-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: event-service-go
    environment:
      SERVER_PORT: 8081
      ENV: development
      LOG_LEVEL: info
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: root
      DB_PASSWORD: root
      DB_NAME: crm
      REDIS_NODE_1: redis-node-1:7001
      REDIS_NODE_2: redis-node-2:7002
      REDIS_NODE_3: redis-node-3:7003
      REDIS_NODE_4: redis-node-4:7004
      REDIS_NODE_5: redis-node-5:7005
      REDIS_NODE_6: redis-node-6:7006
      REDIS_PASSWORD: ""
    ports:
      - "8081:8081"
    depends_on:
      mysql:
        condition: service_healthy
      redis-cluster-creator:
        condition: service_completed_successfully
    restart: unless-stopped

volumes:
  mysql_data:
  redis_1_data:
  redis_2_data:
  redis_3_data:
  redis_4_data:
  redis_5_data:
  redis_6_data:
