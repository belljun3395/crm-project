name: Update Documentation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/src/main/kotlin/**/*UseCase.kt'
      - 'backend/src/main/kotlin/**/domain/*.kt'
      - 'backend/src/main/kotlin/**/controller/*.kt'
  
  # 수동 실행 옵션 (필요시)
  workflow_dispatch:

jobs:
  update-documentation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js for Claude Code
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install Claude Code
      run: |
        npm install -g @anthropic-ai/claude-code-cli
        
    - name: Detect UseCase changes
      id: detect-changes
      run: |
        echo "Detecting UseCase and Domain changes..."
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E "(UseCase\.kt|domain/.*\.kt|controller/.*\.kt)" || echo "")
        
        if [ -n "$CHANGED_FILES" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Generate documentation updates
      if: steps.detect-changes.outputs.changed == 'true'
      run: |
        echo "Analyzing changed files:"
        echo "${{ steps.detect-changes.outputs.files }}"
        
        # Claude Code를 사용하여 문서 업데이트
        cat > update_docs_prompt.md << 'EOF'
        다음 파일들이 변경되었습니다:
        ${{ steps.detect-changes.outputs.files }}
        
        현재 문서 파일들을 분석하고 변경사항을 반영하여 업데이트해주세요:
        - Domain-and-UseCase-Flows.md
        
        특히 다음 사항들을 체크해주세요:
        1. 새로운 UseCase 추가/변경
        2. Domain Entity 변경사항
        3. API 엔드포인트 변경
        4. 비즈니스 로직 플로우 변경
        5. 데이터 관계 변경
        EOF
        
        # Claude Code CLI 실행
        claude-code --file update_docs_prompt.md
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        
    - name: Check for documentation changes
      id: doc-changes
      run: |
        if git diff --quiet *.md; then
          echo "no_changes=true" >> $GITHUB_OUTPUT
        else
          echo "no_changes=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Create Pull Request
      if: steps.doc-changes.outputs.no_changes == 'false'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          📚 Auto-update documentation based on code changes
          
          Changed files:
          ${{ steps.detect-changes.outputs.files }}
          
          🤖 Generated with Claude Code automation
        title: "📚 Documentation Update - $(date +'%Y-%m-%d')"
        body: |
          ## 📚 자동 생성된 문서 업데이트
          
          다음 파일들의 변경사항을 반영하여 문서를 업데이트했습니다:
          
          ### 🔄 변경된 파일들:
          ```
          ${{ steps.detect-changes.outputs.files }}
          ```
          
          ### 📋 업데이트된 문서:
          - Domain-and-UseCase-Flows.md
          
          ### 🤖 자동화 정보
          - **생성 도구**: Claude Code CLI
          - **트리거**: 코드 변경 감지
          - **실행 시간**: ${{ github.event.head_commit.timestamp }}
          
          ### ✅ 리뷰 포인트
          - [ ] UseCase 플로우 다이어그램 정확성 확인
          - [ ] Domain Entity 관계 반영 여부 확인
          - [ ] API 스펙 업데이트 확인
          - [ ] 비즈니스 로직 설명 정확성 확인
          
          ---
          
          > 이 PR은 자동으로 생성되었습니다. 내용을 검토한 후 머지해주세요.
        branch: docs/auto-update-$(date +'%Y%m%d-%H%M%S')
        branch-suffix: timestamp
        delete-branch: true
        labels: |
          documentation
          auto-generated
        assignees: |
          ${{ github.actor }}
        reviewers: |
          ${{ github.actor }}