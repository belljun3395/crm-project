name: Update Documentation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/src/main/kotlin/**/*UseCase.kt'
      - 'backend/src/main/kotlin/**/domain/*.kt'
      - 'backend/src/main/kotlin/**/controller/*.kt'
  
  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜ (í•„ìš”ì‹œ)
  workflow_dispatch:

jobs:
  update-documentation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js for Claude Code
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install Claude Code
      run: |
        npm install -g @anthropic-ai/claude-code-cli
        
    - name: Detect UseCase changes
      id: detect-changes
      run: |
        echo "Detecting UseCase and Domain changes..."
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E "(UseCase\.kt|domain/.*\.kt|controller/.*\.kt)" || echo "")
        
        if [ -n "$CHANGED_FILES" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Generate documentation updates
      if: steps.detect-changes.outputs.changed == 'true'
      run: |
        echo "Analyzing changed files:"
        echo "${{ steps.detect-changes.outputs.files }}"
        
        # Claude Codeë¥¼ ì‚¬ìš©í•˜ì—¬ ë¬¸ì„œ ì—…ë°ì´íŠ¸
        cat > update_docs_prompt.md << 'EOF'
        ë‹¤ìŒ íŒŒì¼ë“¤ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤:
        ${{ steps.detect-changes.outputs.files }}
        
        í˜„ì¬ ë¬¸ì„œ íŒŒì¼ë“¤ì„ ë¶„ì„í•˜ê³  ë³€ê²½ì‚¬í•­ì„ ë°˜ì˜í•˜ì—¬ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”:
        - Domain-and-UseCase-Flows.md
        
        íŠ¹íˆ ë‹¤ìŒ ì‚¬í•­ë“¤ì„ ì²´í¬í•´ì£¼ì„¸ìš”:
        1. ìƒˆë¡œìš´ UseCase ì¶”ê°€/ë³€ê²½
        2. Domain Entity ë³€ê²½ì‚¬í•­
        3. API ì—”ë“œí¬ì¸íŠ¸ ë³€ê²½
        4. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í”Œë¡œìš° ë³€ê²½
        5. ë°ì´í„° ê´€ê³„ ë³€ê²½
        EOF
        
        # Claude Code CLI ì‹¤í–‰
        claude-code --file update_docs_prompt.md
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        
    - name: Check for documentation changes
      id: doc-changes
      run: |
        if git diff --quiet *.md; then
          echo "no_changes=true" >> $GITHUB_OUTPUT
        else
          echo "no_changes=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Create Pull Request
      if: steps.doc-changes.outputs.no_changes == 'false'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          ğŸ“š Auto-update documentation based on code changes
          
          Changed files:
          ${{ steps.detect-changes.outputs.files }}
          
          ğŸ¤– Generated with Claude Code automation
        title: "ğŸ“š Documentation Update - $(date +'%Y-%m-%d')"
        body: |
          ## ğŸ“š ìë™ ìƒì„±ëœ ë¬¸ì„œ ì—…ë°ì´íŠ¸
          
          ë‹¤ìŒ íŒŒì¼ë“¤ì˜ ë³€ê²½ì‚¬í•­ì„ ë°˜ì˜í•˜ì—¬ ë¬¸ì„œë¥¼ ì—…ë°ì´íŠ¸í–ˆìŠµë‹ˆë‹¤:
          
          ### ğŸ”„ ë³€ê²½ëœ íŒŒì¼ë“¤:
          ```
          ${{ steps.detect-changes.outputs.files }}
          ```
          
          ### ğŸ“‹ ì—…ë°ì´íŠ¸ëœ ë¬¸ì„œ:
          - Domain-and-UseCase-Flows.md
          
          ### ğŸ¤– ìë™í™” ì •ë³´
          - **ìƒì„± ë„êµ¬**: Claude Code CLI
          - **íŠ¸ë¦¬ê±°**: ì½”ë“œ ë³€ê²½ ê°ì§€
          - **ì‹¤í–‰ ì‹œê°„**: ${{ github.event.head_commit.timestamp }}
          
          ### âœ… ë¦¬ë·° í¬ì¸íŠ¸
          - [ ] UseCase í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨ ì •í™•ì„± í™•ì¸
          - [ ] Domain Entity ê´€ê³„ ë°˜ì˜ ì—¬ë¶€ í™•ì¸
          - [ ] API ìŠ¤í™ ì—…ë°ì´íŠ¸ í™•ì¸
          - [ ] ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì„¤ëª… ì •í™•ì„± í™•ì¸
          
          ---
          
          > ì´ PRì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ë‚´ìš©ì„ ê²€í† í•œ í›„ ë¨¸ì§€í•´ì£¼ì„¸ìš”.
        branch: docs/auto-update-$(date +'%Y%m%d-%H%M%S')
        branch-suffix: timestamp
        delete-branch: true
        labels: |
          documentation
          auto-generated
        assignees: |
          ${{ github.actor }}
        reviewers: |
          ${{ github.actor }}