name: Update Documentation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/src/main/kotlin/**/*UseCase.kt'
      - 'backend/src/main/kotlin/**/domain/**/*.kt'
      - 'backend/src/main/kotlin/**/controller/**/*.kt'
  
  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜ (í•„ìš”ì‹œ)
  workflow_dispatch:

jobs:
  update-documentation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python for Claude CLI
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Install Claude CLI
      run: |
        pip install anthropic
        
    - name: Detect UseCase changes
      id: detect-changes
      run: |
        echo "Detecting UseCase and Domain changes..."
        
        # workflow_dispatchì¸ ê²½ìš° ê°•ì œë¡œ ë³€ê²½ëœ ê²ƒìœ¼ë¡œ ì²˜ë¦¬ (í…ŒìŠ¤íŠ¸ìš©)
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "Manual trigger - testing documentation update" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | grep -E "(UseCase\.kt|domain/.*\.kt|controller/.*\.kt)" || echo "")
          
          if [ -n "$CHANGED_FILES" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
        fi
    
    - name: Generate documentation updates
      if: steps.detect-changes.outputs.changed == 'true'
      run: |
        echo "Analyzing changed files:"
        echo "${{ steps.detect-changes.outputs.files }}"
        
        # ê°„ë‹¨í•œ ë¬¸ì„œ ì—…ë°ì´íŠ¸ (í…ŒìŠ¤íŠ¸ìš©)
        echo "## ìë™ ë¬¸ì„œ ì—…ë°ì´íŠ¸ - $(date)" >> docs/Domain-and-UseCase-Flows.md
        echo "" >> docs/Domain-and-UseCase-Flows.md
        echo "ë³€ê²½ëœ íŒŒì¼ë“¤:" >> docs/Domain-and-UseCase-Flows.md
        echo '${{ steps.detect-changes.outputs.files }}' >> docs/Domain-and-UseCase-Flows.md
        echo "" >> docs/Domain-and-UseCase-Flows.md
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        
    - name: Check for documentation changes
      id: doc-changes
      run: |
        git add docs/Domain-and-UseCase-Flows.md
        if git diff --staged --quiet; then
          echo "no_changes=true" >> $GITHUB_OUTPUT
          echo "No changes detected in documentation files"
        else
          echo "no_changes=false" >> $GITHUB_OUTPUT
          echo "Changes detected in documentation files"
          git diff --staged --name-only
        fi
    
    - name: Create Pull Request
      if: steps.doc-changes.outputs.no_changes == 'false'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          ğŸ“š Auto-update documentation based on code changes
          
          Changed files:
          ${{ steps.detect-changes.outputs.files }}
          
          ğŸ¤– Generated with Claude Code automation
        title: "ğŸ“š Documentation Update - ${{ github.run_number }}"
        body: |
          ## ğŸ“š ìë™ ìƒì„±ëœ ë¬¸ì„œ ì—…ë°ì´íŠ¸
          
          ë‹¤ìŒ íŒŒì¼ë“¤ì˜ ë³€ê²½ì‚¬í•­ì„ ë°˜ì˜í•˜ì—¬ ë¬¸ì„œë¥¼ ì—…ë°ì´íŠ¸í–ˆìŠµë‹ˆë‹¤:
          
          ### ğŸ”„ ë³€ê²½ëœ íŒŒì¼ë“¤:
          ```
          ${{ steps.detect-changes.outputs.files }}
          ```
          
          ### ğŸ“‹ ì—…ë°ì´íŠ¸ëœ ë¬¸ì„œ:
          - Domain-and-UseCase-Flows.md
          
          ### ğŸ¤– ìë™í™” ì •ë³´
          - **ìƒì„± ë„êµ¬**: Claude Code CLI
          - **íŠ¸ë¦¬ê±°**: ì½”ë“œ ë³€ê²½ ê°ì§€
          - **ì‹¤í–‰ ì‹œê°„**: ${{ github.event.head_commit.timestamp }}
          
          ### âœ… ë¦¬ë·° í¬ì¸íŠ¸
          - [ ] UseCase í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨ ì •í™•ì„± í™•ì¸
          - [ ] Domain Entity ê´€ê³„ ë°˜ì˜ ì—¬ë¶€ í™•ì¸
          - [ ] API ìŠ¤í™ ì—…ë°ì´íŠ¸ í™•ì¸
          - [ ] ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì„¤ëª… ì •í™•ì„± í™•ì¸
          
          ---
          
          > ì´ PRì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ë‚´ìš©ì„ ê²€í† í•œ í›„ ë¨¸ì§€í•´ì£¼ì„¸ìš”.
        branch: docs/auto-update-${{ github.run_number }}
        branch-suffix: timestamp
        delete-branch: true
        labels: |
          documentation
          auto-generated
        assignees: |
          ${{ github.actor }}
        reviewers: |
          ${{ github.actor }}