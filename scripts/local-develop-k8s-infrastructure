#!/bin/sh

set -e

echo "ğŸš€ Starting Kubernetes infrastructure deployment..."

INFRA_DIR="../k8s/infrastructure"
ORIGINAL_DIR=$(pwd)
echo "ğŸ“Executing the script in the directory: $ORIGINAL_DIR"

if [ ! -d "$INFRA_DIR" ]; then
  echo "âŒ Error: Directory $INFRA_DIR does not exist!"
  exit 1
fi

echo "ğŸ“‚ Changing directory to infrastructure manifests..."
cd "$INFRA_DIR"

echo "ğŸ—‘ Deleting existing infrastructure resources..."
kubectl delete -f . || echo "âš ï¸  Warning: Some infrastructure resources might not exist."

echo "ğŸ“¦ Applying new infrastructure manifests..."
kubectl apply -f .

echo "âœ… Infrastructure resources updated successfully."

echo "ğŸ”™ Returning to the original script directory: $ORIGINAL_DIR"
cd "$ORIGINAL_DIR"

echo "ğŸ”„ Running Grafana reset script..."
GRAFANA_RESET_SCRIPT="./local-develop-grafana-reset"

if [ -x "$GRAFANA_RESET_SCRIPT" ]; then
  "$GRAFANA_RESET_SCRIPT"
  echo "âœ… Grafana reset script executed successfully."
else
  echo "âŒ Error: Grafana reset script not found or not executable!"
  exit 1
fi

echo "ğŸ‰ Kubernetes infrastructure deployment completed!"