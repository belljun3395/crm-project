#!/bin/bash

LOCAL_DIR="../k8s/infrastructure/grafana-dashboard"
GRAFANA_DIR="/dashboard"
NAMESPACE="default"

GRAFANA_POD=$(kubectl get pods -n $NAMESPACE -l app=crm-grafana -o jsonpath="{.items[0].metadata.name}")

ORIGINAL_DIR=$(pwd)
echo "ğŸ“Executing the script in the directory: $ORIGINAL_DIR"

if [ -z "$GRAFANA_POD" ]; then
  echo "âŒ Grafana Podë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”."
  exit 1
fi

echo "âœ… Grafana Pod: $GRAFANA_POD"

echo "â³ Waiting for Grafana Pod to be ready..."
while [[ $(kubectl get pod "$GRAFANA_POD" -n $NAMESPACE -o jsonpath="{.status.phase}") != "Running" ]]; do
  echo "â³ Pod is not ready yet. Retrying in 5 seconds..."
  sleep 5
done

echo "âœ… Grafana Pod is now running!"

for FILE in "$LOCAL_DIR"/*.json; do
  FILE_NAME=$(basename "$FILE")
  echo "â¬†ï¸  Uploading $FILE to $GRAFANA_POD:$GRAFANA_DIR/$FILE_NAME"
  kubectl cp "$FILE" "$GRAFANA_POD":"$GRAFANA_DIR/$FILE_NAME" -n $NAMESPACE
done

# Grafana Pod ì¬ì‹œì‘
echo "ğŸ”„ Restarting Grafana Pod..."
kubectl rollout restart deployment crm-grafana -n $NAMESPACE

echo "ğŸ”™ Returning to the original script directory: $ORIGINAL_DIR"
cd "$ORIGINAL_DIR"

echo "âœ… Done! Check Grafana UI for new dashboards."