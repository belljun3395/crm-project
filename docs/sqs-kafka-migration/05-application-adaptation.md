# 애플리케이션 적응 전략

## 프로듀서 변경
- 메시징 인터페이스를 활용해 전송 수단별 프로듀서 설정을 캡슐화합니다.
- Kafka 프로듀서에 멱등 옵션(`enable.idempotence=true`)을 적용하고, SQS와 유사한 재시도·백오프 정책을 구성합니다.
- 이벤트 ID, 상관관계 ID, 스키마 버전 등 공통 메타데이터를 모든 전송 수단에 일관되게 포함합니다.

## 컨슈머 변경
- SQS Visibility Timeout 로직을 명시적 오프셋 커밋(`commitSync`/`commitAsync`)으로 대체합니다.
- Redis나 데이터베이스에 저장한 고유 이벤트 ID를 활용해 멱등 처리를 구현합니다.
- 파티션 리밸런스 시 처리를 일시 중지해 중복 작업을 방지하고, 재개 시 안전하게 이어받습니다.

## 오류 처리 및 재시도
- SQS DLQ 동작을 Kafka DLQ 토픽으로 매핑하고, 실패 사유·재시도 횟수·원본 파티션을 헤더로 기록합니다.
- 전용 재시도 토픽이나 애플리케이션 지연 로직을 통해 지수 백오프를 구현합니다.
- DLQ 메시지를 복구 후 본 토픽으로 되돌리는 리플레이 도구를 제공합니다.

## 구성 관리
- Spring 설정을 통해 Kafka 부트스트랩 서버, 보안, 배치 설정 등을 외부화합니다.
- 롤아웃 제어를 위해 `messaging.transport`, `messaging.dualWriteEnabled`와 같은 기능 플래그를 도입합니다.
- 듀얼 라이트 기간에는 메시지마다 사용한 전송 수단을 로깅해 감사를 용이하게 합니다.

## 관측성 훅
- 발행/소비 결과를 트레이스 ID와 함께 구조화 로그로 출력합니다.
- Micrometer 지표(프로듀서 성공/실패 횟수, 컨슈머 lag, DLQ 처리량)를 노출합니다.
- 경보 임계값을 SQS 기준으로 맞춘 뒤 Kafka 특성을 반영해 단계적으로 조정합니다.
